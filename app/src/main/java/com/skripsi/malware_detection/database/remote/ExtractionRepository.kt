package com.skripsi.malware_detection.database.remote

import com.skripsi.malware_detection.database.local.entity.ExtractionEntity
import com.skripsi.malware_detection.database.local.room.ExtractionDao
import com.skripsi.malware_detection.database.remote.response.UploadApkResponse
import com.skripsi.malware_detection.database.remote.retrofit.ExtractionApiService
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.MultipartBody
import okhttp3.RequestBody.Companion.asRequestBody
import retrofit2.Response
import java.io.File

class ExtractionRepository private constructor(
    private val extractionApiService: ExtractionApiService,
    private val extractionDao: ExtractionDao
){
    suspend fun createExtraction(apkFile: File): Response<UploadApkResponse> {
        val requestBody = apkFile.asRequestBody(
            "application/vnd.android.package-archive".toMediaType()
        )

        val part = MultipartBody.Part.createFormData(
            name = "file",
            filename = apkFile.name,
            body = requestBody
        )

        return extractionApiService.uploadApk(part)
    }

    suspend fun addExtractionInfo(extraction: ExtractionEntity) = extractionDao.insertExtraction(extraction)

    suspend fun updateExtractionStatus(eid: String, status: String) = extractionDao.updateExtractionStatus(eid, status)

    companion object{
        @Volatile
        private var instance: ExtractionRepository? = null

        fun getInstance(
            extractionApiService: ExtractionApiService,
            extractionDao: ExtractionDao
        ): ExtractionRepository =
            instance ?: synchronized(this) {
                instance ?: ExtractionRepository(extractionApiService, extractionDao)
            }.also { instance = it }
    }
}