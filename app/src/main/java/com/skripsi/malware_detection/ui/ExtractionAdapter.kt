package com.skripsi.malware_detection.ui

import android.content.Intent
import android.util.TypedValue
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.core.content.ContextCompat.startActivity
import androidx.recyclerview.widget.DiffUtil
import androidx.recyclerview.widget.ListAdapter
import androidx.recyclerview.widget.RecyclerView
import com.skripsi.malware_detection.R
import com.skripsi.malware_detection.database.local.entity.ExtractionEntity
import com.skripsi.malware_detection.databinding.ItemExtractionBinding
import com.skripsi.malware_detection.ui.result.ResultActivity
import com.skripsi.malware_detection.util.Util

class ExtractionAdapter(private val onDeleteClick: (ExtractionEntity) -> Unit):
    ListAdapter<ExtractionEntity, ExtractionAdapter.MyViewHolder>(DIFF_CALLBACK) {

    override fun onCreateViewHolder(
        parent: ViewGroup,
        viewType: Int
    ): ExtractionAdapter.MyViewHolder {
        val binding = ItemExtractionBinding.inflate(LayoutInflater.from(parent.context), parent, false)
        return MyViewHolder(binding)
    }

    override fun onBindViewHolder(holder: ExtractionAdapter.MyViewHolder, position: Int) {
        val extraction = getItem(position)
        holder.bind(extraction, onDeleteClick)
    }

    class MyViewHolder(val binding: ItemExtractionBinding): RecyclerView.ViewHolder(binding.root){
        fun bind(
            extraction: ExtractionEntity,
            onDeleteClick: (ExtractionEntity) -> Unit)
        {
            val typedValue = TypedValue()
            val theme = binding.root.context.theme

            val completedColor = run {
                theme.resolveAttribute(R.attr.colorCompleted, typedValue, true)
                typedValue.data
            }

            val failedColor = run {
                theme.resolveAttribute(R.attr.colorFailed, typedValue, true)
                typedValue.data
            }

            if(extraction.status == "completed"){
                binding.vStatusColor.setBackgroundColor(completedColor)
                binding.vDeleteBackground.visibility = View.VISIBLE
                binding.imgDelete.visibility = View.VISIBLE
            }
            else if(extraction.status == "failed"){
                binding.vStatusColor.setBackgroundColor(failedColor)
                binding.vDeleteBackground.visibility = View.VISIBLE
                binding.imgDelete.visibility = View.VISIBLE
            }

            binding.tvApkName.text = extraction.apkName
            binding.tvExtractionDate.text = Util.formatTimestampMilis(extraction.timestamp)
            binding.tvStatusContent.text = extraction.status

            binding.imgDelete.setOnClickListener {
                onDeleteClick(extraction)
            }

            itemView.setOnClickListener {
                val intent = Intent(itemView.context, ResultActivity::class.java)
                intent.putExtra(EID, extraction.eid)
                startActivity(itemView.context, intent, null)
            }
        }
    }

    companion object{
        private const val EID = "extractionId"

        val DIFF_CALLBACK: DiffUtil.ItemCallback<ExtractionEntity> =
            object: DiffUtil.ItemCallback<ExtractionEntity>(){
                override fun areItemsTheSame(
                    oldItem: ExtractionEntity,
                    newItem: ExtractionEntity
                ): Boolean {
                    return oldItem.eid == newItem.eid
                }

                override fun areContentsTheSame(
                    oldItem: ExtractionEntity,
                    newItem: ExtractionEntity
                ): Boolean {
                    return oldItem == newItem
                }

            }
    }
}