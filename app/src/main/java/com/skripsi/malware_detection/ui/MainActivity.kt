package com.skripsi.malware_detection.ui

import android.net.nsd.NsdManager
import android.net.nsd.NsdManager.DiscoveryListener
import android.net.nsd.NsdServiceInfo
import android.os.Bundle
import android.util.Log
import android.widget.TextView
import androidx.activity.enableEdgeToEdge
import androidx.appcompat.app.AppCompatActivity
import androidx.core.view.ViewCompat
import androidx.core.view.WindowInsetsCompat
import androidx.core.view.setPadding
import androidx.core.view.updateLayoutParams
import androidx.navigation.fragment.NavHostFragment
import androidx.navigation.ui.AppBarConfiguration
import androidx.navigation.ui.setupActionBarWithNavController
import androidx.navigation.ui.setupWithNavController
import com.skripsi.malware_detection.R
import com.skripsi.malware_detection.databinding.ActivityMainBinding

class MainActivity : AppCompatActivity() {

    private var _binding: ActivityMainBinding? = null
    private val binding get() = _binding!!

    // mDNS
    private lateinit var nsdManager: NsdManager
    private lateinit var discoveryListener: NsdManager.DiscoveryListener
    private val discoveredDns = mutableMapOf<String, String>()
    private val resolvingServices = mutableSetOf<String>()
    private var isDiscovering = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()

        _binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)
        supportActionBar?.hide()

        nsdManager = getSystemService(NSD_SERVICE) as NsdManager

        setupEdgeToEdge()
        setupBottomNavigation()
    }

    private fun setupEdgeToEdge() {
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main)) { v, insets ->
            val systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            v.setPadding(systemBars.left, 0, systemBars.right, 0)

            binding.topBackground.updateLayoutParams {
                height = systemBars.top
            }
            insets
        }
    }

    private fun setupBottomNavigation() {
        val navHostFragment = supportFragmentManager
            .findFragmentById(R.id.nav_host_fragment_activity_main) as NavHostFragment

        val navController = navHostFragment.navController

        val appBarConfiguration = AppBarConfiguration(
            setOf(
                R.id.navigation_add,
                R.id.navigation_list,
                R.id.navigation_settings
            )
        )

        setupActionBarWithNavController(navController, appBarConfiguration)
        binding.bottomNavView.setupWithNavController(navController)
    }

    override fun onResume() {
        super.onResume()
        startDiscovery()
    }

    override fun onPause() {
        super.onPause()
        stopDiscovery()
    }

    private fun startDiscovery() {
        if (isDiscovering) return
        isDiscovering = true

        discoveryListener = object : NsdManager.DiscoveryListener {

            override fun onDiscoveryStarted(serviceType: String?) {}

            override fun onStartDiscoveryFailed(serviceType: String?, errorCode: Int) {
                stopDiscovery()
            }

            override fun onStopDiscoveryFailed(serviceType: String?, errorCode: Int) {
                stopDiscovery()
            }

            override fun onDiscoveryStopped(serviceType: String?) {}

            override fun onServiceFound(serviceInfo: NsdServiceInfo?) {
                if (serviceInfo?.serviceType != "_skripsi._tcp.") return

                val key = serviceInfo.serviceName.lowercase()
                if (key in resolvingServices || key in discoveredDns) return

                resolvingServices.add(key)

                nsdManager.resolveService(serviceInfo, object : NsdManager.ResolveListener {
                    override fun onResolveFailed(serviceInfo: NsdServiceInfo?, errorCode: Int) {
                        resolvingServices.remove(key)
                    }

                    override fun onServiceResolved(serviceInfo: NsdServiceInfo?) {
                        val host = serviceInfo?.host?.hostName ?: return
                        val port = serviceInfo.port

                        Log.d(
                            "mDNS",
                            "Resolved ${serviceInfo.serviceName} -> http://${serviceInfo.host.hostName}:${serviceInfo.port}"
                        )

                        discoveredDns[key] = "http://$host:$port/"
                        resolvingServices.remove(key)
                    }
                })
            }

            override fun onServiceLost(serviceInfo: NsdServiceInfo?) {
                serviceInfo?.serviceName?.lowercase()?.let {
                    discoveredDns.remove(it)
                    resolvingServices.remove(it)
                }
            }
        }

        nsdManager.discoverServices(
            "_skripsi._tcp.",
            NsdManager.PROTOCOL_DNS_SD,
            discoveryListener
        )
    }

    private fun stopDiscovery() {
        if (!isDiscovering) return
        try {
            nsdManager.stopServiceDiscovery(discoveryListener)
        } catch (_: Exception) {}
        isDiscovering = false
    }

    fun getDiscoveredMdns(): Map<String, String> =
        discoveredDns.toMap()

    fun saveSelectedMdns(name: String, url: String) {
        val prefs = getSharedPreferences("mdns_config", MODE_PRIVATE)
        prefs.edit()
            .putString("mdns_name", name)
            .putString("mdns_url", url)
            .apply()
    }
}