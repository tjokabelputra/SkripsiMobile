package com.skripsi.malware_detection.ui.result

import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.skripsi.malware_detection.database.local.entity.ExtractionResultEntity
import com.skripsi.malware_detection.database.remote.ExtractionResultRepository
import com.skripsi.malware_detection.database.remote.Result
import kotlinx.coroutines.launch

class ResultViewModel(private val extractionResultRepository: ExtractionResultRepository): ViewModel() {
    val resultStatus = MutableLiveData<Result<ExtractionResultEntity>>()

    fun getExtractionResult(task_id: String) = viewModelScope.launch {
        resultStatus.postValue(Result.Loading)

        try {
            val response = extractionResultRepository.getExtractionResult(task_id)

            if(response.isSuccessful){
                val data = response.body()?.data
                    ?: return@launch resultStatus.postValue(
                        Result.Error("Empty response body")
                    )
                val entity = ExtractionResultEntity(
                    eid = data.metadata.tid,
                    apkName = data.metadata.name,
                    apkSize = data.metadata.apkSize,
                    startTime = data.metadata.startTime,
                    endTime = data.metadata.endTime!!,
                    extractionDuration = data.metadata.durationTime!!,
                    pcaResult = data.pca
                )
                extractionResultRepository.insertExtractionResult(entity)
                resultStatus.postValue(Result.Success(entity))
            }
            else{
                resultStatus.postValue(Result.Error("Fetch failed: ${response.code()}"))
            }
        }
        catch (e: Exception){
            resultStatus.postValue(Result.Error(e.message ?: "Unknown error"))
        }
    }

    fun getExtractionResultRoom(eid: String) = extractionResultRepository.getExtractionResultRoom(eid)

    fun deleteExtractionResult(eid: String) = viewModelScope.launch {
        extractionResultRepository.deleteExtractionResult(eid)
    }
}