package com.skripsi.malware_detection.ui.result

import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.skripsi.malware_detection.database.local.entity.ExtractionResultEntity
import com.skripsi.malware_detection.database.remote.ExtractionResultRepository
import com.skripsi.malware_detection.database.remote.Result
import kotlinx.coroutines.launch

class ResultViewModel(private val extractionResultRepository: ExtractionResultRepository): ViewModel() {
    val resultStatus = MutableLiveData<Result<ExtractionResultEntity>>()

    fun getExtractionResult(task_id: String) = viewModelScope.launch {
        resultStatus.postValue(Result.Loading)

        try {
            val response = extractionResultRepository.getExtractionResult(task_id)

            if(response.isSuccessful){
                val body = response.body()
                    ?: return@launch resultStatus.postValue(
                        Result.Error("Empty response body")
                    )
                val entity = ExtractionResultEntity(
                    eid = body.extractionId,
                    apkName = body.metadata.apkName,
                    apkSize = body.metadata.apkSizeBytes,
                    startTime = body.metadata.startTime,
                    endTime = body.metadata.endTime,
                    extractionDuration = body.metadata.durationSeconds,
                    pcaResult = body.pca
                )
                extractionResultRepository.insertExtractionResult(entity)
                resultStatus.postValue(Result.Success(entity))
            }
            else{
                resultStatus.postValue(Result.Error("Fetch failed: ${response.code()}"))
            }
        }
        catch (e: Exception){
            resultStatus.postValue(Result.Error(e.message ?: "Unknown error"))
        }
    }

    fun getExtractionResultRoom(eid: String) = extractionResultRepository.getExtractionResultRoom(eid)

    fun deleteExtractionResult(eid: String) = viewModelScope.launch {
        extractionResultRepository.deleteExtractionResult(eid)
    }
}