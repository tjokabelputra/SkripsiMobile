package com.skripsi.malware_detection.ui.add

import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.skripsi.malware_detection.database.local.entity.ExtractionEntity
import com.skripsi.malware_detection.database.remote.ExtractionRepository
import com.skripsi.malware_detection.database.remote.Result
import com.skripsi.malware_detection.database.remote.response.ApiResponse
import com.skripsi.malware_detection.database.remote.response.Schemas.SubmitApkData
import kotlinx.coroutines.launch
import java.io.File

class AddViewModel(private val extractionRepository: ExtractionRepository): ViewModel() {
    val uploadResult = MutableLiveData<Result<ApiResponse<SubmitApkData>>>()

    fun extractApk(apkFile: File) = viewModelScope.launch {
        uploadResult.postValue(Result.Loading)

        try {
            val response = extractionRepository.createExtraction(apkFile)

            if (response.isSuccessful) {
                uploadResult.postValue(
                    Result.Success(response.body()!!)
                )
            } else {
                uploadResult.postValue(
                    Result.Error("Upload failed: ${response.code()}")
                )
            }

        } catch (e: Exception) {
            uploadResult.postValue(
                Result.Error(e.message ?: "Unknown error")
            )
        }
    }

    fun addExtractionInfo(extraction: ExtractionEntity) = viewModelScope.launch {
        extractionRepository.addExtractionInfo(extraction)
    }
}