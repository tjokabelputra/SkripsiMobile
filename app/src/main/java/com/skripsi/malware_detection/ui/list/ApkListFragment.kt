package com.skripsi.malware_detection.ui.list

import android.app.AlertDialog
import android.os.Bundle
import androidx.fragment.app.Fragment
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Toast
import androidx.fragment.app.viewModels
import androidx.lifecycle.Observer
import androidx.recyclerview.widget.LinearLayoutManager
import com.skripsi.malware_detection.database.local.entity.ExtractionEntity
import com.skripsi.malware_detection.database.Result
import com.skripsi.malware_detection.databinding.FragmentApkListBinding
import com.skripsi.malware_detection.ui.ExtractionAdapter
import com.skripsi.malware_detection.ui.ViewModelFactory

class ApkListFragment : Fragment() {

    private var _binding: FragmentApkListBinding? = null
    private val binding get() = _binding!!

    private val extractionAdapter by lazy {
        ExtractionAdapter { extraction ->
            showDeleteConfirmation(extraction)
        }
    }

    private val viewModelFactory: ViewModelFactory by lazy {
        ViewModelFactory.getInstance(requireContext())
    }

    private val apkListViewModel: ApkListViewModel by viewModels {
        viewModelFactory
    }

    private var pendingDeleteEid: String? = null
    private var isUpdating = false

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = FragmentApkListBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        binding.pgLoadList.visibility = View.GONE
        setupAdapter()
        fetchExtractionLists()
        setupViewModelObserver()

        binding.swipeRefresh.setOnRefreshListener {
            refreshStatus()
        }
    }

    override fun onResume() {
        super.onResume()
        updateStatus()
    }

    private fun updateStatus() {
        if (isUpdating) {
            return
        }

        isUpdating = true
        binding.pgLoadList.visibility = View.VISIBLE
        apkListViewModel.batchStatusUpdateComplete.value = false

        apkListViewModel.updateAllProcessingStatus()
    }

    private fun refreshStatus(){
        if (!isUpdating) {
            updateStatus()
        }
    }

    private fun setupAdapter(){
        binding.rvApkList.apply {
            layoutManager = LinearLayoutManager(context)
            adapter = extractionAdapter
        }
    }

    private fun fetchExtractionLists(){
        apkListViewModel.getAllExtractionLists().observe(viewLifecycleOwner) { results ->
            extractionAdapter.submitList(results)
        }
    }

    private fun showDeleteConfirmation(extraction: ExtractionEntity){
        AlertDialog.Builder(requireContext())
            .setTitle("Delete result")
            .setMessage("Delete extraction result for ${extraction.apkName}?")
            .setPositiveButton("Delete") { _, _ ->
                pendingDeleteEid = extraction.eid
                apkListViewModel.deleteExtractionResult(extraction.eid)
            }
            .setNegativeButton("Cancel", null)
            .show()
    }

    private fun setupViewModelObserver(){
        apkListViewModel.deleteResult.observe(viewLifecycleOwner, Observer { response ->
            when(response){
                is Result.Loading -> showLoading(true)
                is Result.Success -> handleDeleteSuccess()
                is Result.Error -> handleDeleteFail(response.error)
            }
        })

        apkListViewModel.batchStatusUpdateComplete.observe(viewLifecycleOwner) { complete ->
            if(complete == true){
                binding.pgLoadList.visibility = View.GONE
                binding.swipeRefresh.isRefreshing = false
                isUpdating = false
                apkListViewModel.batchStatusUpdateComplete.value = false
            }
        }
    }

    private fun showLoading(isLoading: Boolean){
        binding.pgLoadList.visibility = if(isLoading) View.VISIBLE else View.GONE
    }

    private fun handleDeleteSuccess(){
        showLoading(false)
        pendingDeleteEid?.let { eid ->
            apkListViewModel.deleteExtractionStatus(eid)
        }
        pendingDeleteEid = null
    }

    private fun handleDeleteFail(error: String){
        showLoading(false)
        pendingDeleteEid = null
        Toast.makeText(requireContext(), error, Toast.LENGTH_SHORT).show()
    }

    override fun onDestroyView() {
        super.onDestroyView()
        _binding = null
    }
}