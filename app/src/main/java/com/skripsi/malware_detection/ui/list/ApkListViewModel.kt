package com.skripsi.malware_detection.ui.list

import android.util.Log
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.skripsi.malware_detection.database.ExtractionRepository
import com.skripsi.malware_detection.database.ExtractionResultRepository
import com.skripsi.malware_detection.database.Result
import com.skripsi.malware_detection.database.remote.response.ApiResponse
import kotlinx.coroutines.launch

class ApkListViewModel(
    private val extractionRepository: ExtractionRepository,
    private val extractionResultRepository: ExtractionResultRepository
): ViewModel() {
    val deleteResult = MutableLiveData<Result<ApiResponse<Unit>>>()
    val batchStatusUpdateComplete = MutableLiveData<Boolean>()

    fun getAllExtractionLists() = extractionRepository.getAllExtractionInfo()

    fun deleteExtractionStatus(eid: String) = viewModelScope.launch {
        extractionRepository.deleteExtractionStatus(eid)
        extractionResultRepository.deleteExtractionResult(eid)
    }

    fun updateAllProcessingStatus() = viewModelScope.launch {
        batchStatusUpdateComplete.postValue(false)

        try {
            val processingItems = extractionRepository.getProcessingStatusOnce()

            if(processingItems.isEmpty()){
                batchStatusUpdateComplete.postValue(true)
                return@launch
            }

            processingItems.forEach { extraction ->
                try {
                    val response = extractionRepository.getExtractionStatus(extraction.eid)
                    if(response.isSuccessful){
                        response.body()?.data?.status.let { status ->
                            if (status != null) {
                                extractionRepository.updateExtractionStatus(extraction.eid, status)
                            }
                        }
                    }
                }
                catch (e: Exception){
                    Log.e("Update Status", "Error updating ${extraction.eid}: ${e.message}")
                }
            }
        }
        catch (e: Exception){
            Log.e("Update Status", "Error fetching processing items: ${e.message}")
        }

        batchStatusUpdateComplete.postValue(true)
    }

    fun deleteExtractionResult(eid: String) = viewModelScope.launch {
        deleteResult.postValue(Result.Loading)

        try {
            val response = extractionRepository.deleteExtractionResult(eid)

            if(response.isSuccessful){
                deleteResult.postValue(Result.Success(response.body()!!))
            }
            else{
                deleteResult.postValue(Result.Error("Delete failed: ${response.code()}"))
            }
        }
        catch (e: Exception){
            deleteResult.postValue(Result.Error(e.message ?: "Unknown error"))
        }
    }
}